"use strict";var T=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var F=(h,o)=>{for(var e in o)T(h,e,{get:o[e],enumerable:!0})},N=(h,o,e,t)=>{if(o&&typeof o=="object"||typeof o=="function")for(let n of Y(o))!A.call(h,n)&&n!==e&&T(h,n,{get:()=>o[n],enumerable:!(t=H(o,n))||t.enumerable});return h};var I=h=>N(T({},"__esModule",{value:!0}),h);var _={};F(_,{default:()=>S});module.exports=I(_);var f=require("obsidian"),D="year-planner-view",B=!0,R=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],$=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],W=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],M=[{color:"#FFB3BA",label:""},{color:"#BFFCC6",label:""},{color:"#B3E5FC",label:""},{color:"#FFD180",label:""}];function z(){return new Date().getFullYear()}function G(h,o,e){let t=new Date;return t.getFullYear()===h&&t.getMonth()===o&&t.getDate()===e}function q(h,o,e){let t=o+1,n=t<10?`0${t}`:String(t),a=e<10?`0${e}`:String(e);return`${h}-${n}-${a}`}function V(h,o,e){let n=new Date(h,o,1).getDay(),a=e?n===0?6:n-1:n,r=new Date(h,o+1,0).getDate(),d=new Date(h,o,0).getDate(),i=[];for(let s=0;s<42;s++){let u=s-a+1;if(u<1){let m=d+u,g=new Date(h,o-1,m);i.push({y:g.getFullYear(),m:g.getMonth(),d:g.getDate(),inMonth:!1})}else if(u>r){let m=u-r,g=new Date(h,o+1,m);i.push({y:g.getFullYear(),m:g.getMonth(),d:g.getDate(),inMonth:!1})}else i.push({y:h,m:o,d:u,inMonth:!0})}return i}function J(h,o){let e;return(...t)=>{e&&window.clearTimeout(e),e=window.setTimeout(()=>h(...t),o)}}function C(h){if(!h)return"#111";let o=0,e=0,t=0;if(h.startsWith("#")){let a=h.slice(1);a.length===3?(o=parseInt(a[0]+a[0],16),e=parseInt(a[1]+a[1],16),t=parseInt(a[2]+a[2],16)):a.length>=6&&(o=parseInt(a.slice(0,2),16),e=parseInt(a.slice(2,4),16),t=parseInt(a.slice(4,6),16))}else if(h.startsWith("rgb")){let a=h.replace(/rgba?\(|\)/g,"").split(",").map(r=>parseFloat(r.trim()));o=a[0]??0,e=a[1]??0,t=a[2]??0}return(o*299+e*587+t*114)/1e3>=150?"#111":"#fff"}function j(h){return/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(h.trim())}var S=class extends f.Plugin{async onload(){this.registerView(D,o=>new L(this,o)),this.addCommand({id:"open-year-planner",name:"Open Year Planner",callback:()=>this.activateView()}),this.addCommand({id:"toggle-brush",name:"Year Planner: Toggle Brush",callback:()=>this.withView(o=>o.toggleBrush())}),this.addCommand({id:"year-prev",name:"Year Planner: Previous Year",callback:()=>this.withView(o=>o.setYear(o.year-1))}),this.addCommand({id:"year-next",name:"Year Planner: Next Year",callback:()=>this.withView(o=>o.setYear(o.year+1))}),this.addCommand({id:"year-goto",name:"Year Planner: Go to Year\u2026",callback:()=>this.withView(o=>o.promptGotoYear())}),this.addCommand({id:"edit-note-modal",name:"Year Planner: Edit note\u2026",callback:()=>this.withView(o=>o.openEditNoteModal())}),this.addRibbonIcon("calendar","Open Year Planner",()=>this.activateView())}onunload(){this.app.workspace.detachLeavesOfType(D)}withView(o){let e=this.app.workspace.getLeavesOfType(D);e.length?o(e[0].view):new f.Notice("Year Planner: open the view (Open Year Planner)")}async activateView(){let{workspace:o}=this.app,e=o.getLeavesOfType(D)[0];e||(e=o.getRightLeaf(!1),await e.setViewState({type:D,active:!0})),o.revealLeaf(e)}},L=class extends f.ItemView{constructor(e,t){super(t);this.year=z();this.firstDayMonday=B;this.data=null;this.styleEl=null;this.brushEnabled=!1;this.brushColor=M[0].color;this.isDragging=!1;this.lastPickedISO=null;this.saveDebounced=J(()=>this.saveData().catch(console.error),400);this.pendingScrollToMonth=null;this.plugin=e}getViewType(){return D}getDisplayText(){return"Year Planner"}getIcon(){return"calendar"}dataJsonPathFor(e){let t=this.app.vault.configDir;return(0,f.normalizePath)(`${t}/plugins/obsidian-year-planner/data-${e}.json`)}dataMarkdownPathFor(e){return(0,f.normalizePath)(`Year Planner ${e}.md`)}async ensurePluginDir(){let e=(0,f.normalizePath)(`${this.app.vault.configDir}/plugins/obsidian-year-planner`);await this.app.vault.adapter.exists(e)||await this.app.vault.adapter.mkdir(e)}normalizePalette(e){if(e.palettes?.items?.length)return;let t=e.palettes?.colors?.length?e.palettes.colors:M.map(n=>n.color);e.palettes={items:t.map(n=>({color:n,label:""}))}}async loadData(e){await this.ensurePluginDir();let t=this.dataJsonPathFor(e);if(await this.app.vault.adapter.exists(t))try{let n=await this.app.vault.adapter.read(t),a=JSON.parse(n);return a.days||(a.days={}),this.normalizePalette(a),a}catch{}return{year:e,days:{},palettes:{items:M.map(n=>({...n}))},settings:{firstDayOfWeek:this.firstDayMonday?"mon":"sun"}}}async saveData(){if(!this.data)return;await this.ensurePluginDir();let e=this.dataJsonPathFor(this.data.year);await this.app.vault.adapter.write(e,JSON.stringify(this.data,null,2)),await this.writeMarkdownMirror(this.data).catch(()=>{})}mdTemplate(e){let t=JSON.stringify(e,null,2);return`# Year Planner ${e.year}

> Edit the JSON inside the code block below and run **Year Planner: Refresh from Markdown** (command).

\`\`\`json
${t}
\`\`\`
`}async writeMarkdownMirror(e){let t=this.dataMarkdownPathFor(e.year),n=this.app.vault.getAbstractFileByPath(t),a=this.mdTemplate(e);n instanceof f.TFile?await this.app.vault.modify(n,a):await this.app.vault.create(t,a)}extractJsonFromMarkdown(e){let t=e.indexOf("```json");if(t===-1)return null;let n=t+7,a=e.indexOf("```",n);if(a===-1)return null;try{let r=JSON.parse(e.slice(n,a).trim());return r.days||(r.days={}),this.normalizePalette(r),r}catch{return null}}async refreshFromMarkdown(){let e=this.dataMarkdownPathFor(this.year),t=this.app.vault.getAbstractFileByPath(e);if(!(t instanceof f.TFile)){new f.Notice(`Markdown not found: ${e}`);return}let n=await this.app.vault.read(t),a=this.extractJsonFromMarkdown(n);if(!a){new f.Notice("Invalid JSON inside markdown");return}if(a.year!==this.year){await this.setYear(a.year);return}this.data=a,this.firstDayMonday=(this.data.settings?.firstDayOfWeek??"mon")==="mon",this.renderPalette(),this.render(),new f.Notice("Data refreshed from Markdown")}async onOpen(){let e=this.containerEl.children[1];e.empty(),this.styleEl=document.createElement("style"),this.styleEl.textContent=`
      .yp-toolbar { display:flex; flex-direction:column; gap:6px; margin:8px 0 12px; }
      .yp-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
      .yp-year { font-size:18px; font-weight:600; padding:0 6px; }
      .yp-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; align-items:start; align-content:start; --yp-day-h:22px; }
      .yp-month { border:1px solid var(--background-modifier-border); border-radius:8px; padding:8px; height:fit-content; }
      .yp-month h3 { margin:2px 0 6px; font-size:13px; font-weight:700; opacity:.85; }
      .yp-cal { display:grid; grid-template-rows:auto repeat(6,auto); gap:2px; }
      .yp-weekdays { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; font-size:11px; opacity:.8; }
      .yp-weekdays div { text-align:center; padding:2px 0; }
      .yp-weeks { display:grid; grid-template-rows:repeat(6,auto); gap:2px; position:relative; }
      .yp-week { position:relative; display:grid; grid-template-columns:repeat(7,1fr); gap:2px; }
      .yp-day {
        min-height: var(--yp-day-h);
        border-radius:6px; padding:4px; font-size:11px; line-height:1; text-align:right; position:relative;
        background: var(--background-primary); border:1px solid var(--background-modifier-border);
        user-select:none; overflow:hidden;
      }
      .yp-day.is-outside { visibility:hidden; pointer-events:none; user-select:none; }

      .yp-day.is-today {
        box-shadow: 0 0 0 2px var(--interactive-accent), inset 0 0 0 999px color-mix(in srgb, var(--interactive-accent) 12%, transparent);
      }
      .yp-day.is-selected { outline:2px solid var(--text-accent); outline-offset:-2px; }

      .yp-day.has-color { font-weight:600; }
      .note-dot { position:absolute; left:4px; bottom:3px; width:6px; height:6px; border-radius:50%; background: var(--interactive-accent); opacity:.9; }

      /* run pill \u2014 \u0435\u0434\u0438\u043D\u044B\u0439 \u0441\u0435\u0433\u043C\u0435\u043D\u0442 */
      .run-pill {
        position:absolute; height:var(--yp-day-h); border-radius:8px;
        display:flex; align-items:center; justify-content:center; font-weight:400; font-size:12px;
        pointer-events:none; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;
        box-shadow: 0 0 0 1px var(--background-modifier-border) inset;
        top:0; left:0;
      }
      .hide-number { color: transparent !important; text-shadow:none !important; }

      .yp-tooltip {
        background: var(--background-secondary); border:1px solid var(--background-modifier-border);
        padding:4px 6px; border-radius:6px; font-size:12px; max-width:240px; white-space:normal; pointer-events:none;
      }

      .yp-toolbar button { border:1px solid var(--background-modifier-border); background:var(--background-primary); padding:4px 8px; border-radius:6px; cursor:pointer; }
      .yp-toolbar button:hover { background: var(--background-modifier-hover); }

      /* ==== GROUPS chips ==== */
      .yp-palette { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
      .yp-chip { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--background-modifier-border); border-radius:10px; background: var(--background-secondary); }
      .yp-swatch { width:18px; height:18px; border-radius:4px; border:1px solid var(--background-modifier-border); cursor:pointer; }
      .yp-swatch.is-active { outline:2px solid var(--interactive-accent); }
      .yp-legend { font-size:12px; opacity:.9; user-select:none; pointer-events:none; } /* \u043D\u0435 \u043A\u043B\u0438\u043A\u0430\u0431\u0435\u043B\u044C\u043D\u043E */

      .yp-btn-toggle.on { background: var(--interactive-accent); color: var(--text-on-accent); }
      .yp-hint { opacity:.7; font-size:12px; }

      .spacer { flex:1; }
      .muted { opacity:.7; }
      .inp { padding:4px 6px; border:1px solid var(--background-modifier-border); border-radius:6px; background:var(--background-primary); }
    `,document.head.appendChild(this.styleEl);let t=e.createDiv({cls:"yp-toolbar"}),n=t.createDiv({cls:"yp-row"}),a=t.createDiv({cls:"yp-row"}),r=t.createDiv({cls:"yp-row"}),d=n.createEl("button",{text:"\u2190 Year"}),i=n.createDiv({cls:"yp-year",text:String(this.year)}),s=n.createEl("button",{text:"Year \u2192"});n.createDiv({cls:"spacer"});let u=n.createEl("button",{text:"Group Settings"});d.onclick=()=>this.setYear(this.year-1),s.onclick=()=>this.setYear(this.year+1),u.onclick=()=>this.openGroupSettingsModal();let m=a.createDiv({cls:"yp-palette"});m.createSpan({text:"Groups:"});let g=a.createEl("button",{text:"Brush OFF"});g.addClass("yp-btn-toggle");let c=a.createEl("button",{text:"Edit note"});g.onclick=()=>this.toggleBrush(),c.onclick=()=>this.openEditNoteModal(),r.createSpan({cls:"yp-hint",text:"Brush ON: paint \u2022 Brush OFF: click = edit note \u2022 Alt-click = clear"});let p=e.createDiv({cls:"yp-grid"});this.elGlobal=n,this.elLocal=a,this.elHint=r,this.elRefs={yearEl:i,grid:p,btnBrush:g,paletteWrap:m,toolbar:t},this.keydownHandler=l=>{this.containerEl.contains(document.activeElement)&&(l.key==="ArrowLeft"&&(this.setYear(this.year-1),l.preventDefault()),l.key==="ArrowRight"&&(this.setYear(this.year+1),l.preventDefault()),l.key.toLowerCase()==="b"&&(this.toggleBrush(),l.preventDefault()),l.key.toLowerCase()==="n"&&(this.openEditNoteModal(),l.preventDefault()))},window.addEventListener("keydown",this.keydownHandler,!0),window.addEventListener("mouseup",()=>{this.isDragging=!1},!0),this.data=await this.loadData(this.year),this.firstDayMonday=(this.data.settings?.firstDayOfWeek??"mon")==="mon",await this.writeMarkdownMirror(this.data).catch(()=>{}),this.renderPalette(),this.render(),this.resizeHandler=()=>{this.recomputeCellHeight(),this.renderAllRunPills()},window.addEventListener("resize",this.resizeHandler,{passive:!0}),this.recomputeCellHeight(),this.renderAllRunPills()}async onClose(){window.removeEventListener("keydown",this.keydownHandler,!0),window.removeEventListener("resize",this.resizeHandler),this.styleEl?.remove(),this.styleEl=null}clearHoverTips(){document.querySelectorAll(".yp-tooltip").forEach(e=>e.remove())}renderPalette(){let e=this.data?.palettes?.items?.length?this.data.palettes.items:M,t=this.elRefs.paletteWrap;for(;t.children.length>1;)t.lastElementChild?.remove();e.forEach(n=>{let a=t.createDiv({cls:"yp-chip"}),r=a.createDiv({cls:"yp-swatch"});r.style.background=n.color,this.brushColor===n.color&&r.addClass("is-active");let d=a.createSpan({cls:"yp-legend",text:n.label??""});r.addEventListener("click",()=>{this.brushColor=n.color,t.querySelectorAll(".yp-swatch").forEach(i=>i.removeClass("is-active")),r.addClass("is-active")}),a.addEventListener("contextmenu",i=>{i.preventDefault(),this.openGroupSettingsModal()}),a.addEventListener("dblclick",()=>this.openGroupSettingsModal())})}toggleBrush(){this.brushEnabled=!this.brushEnabled,this.elRefs.btnBrush.setText(this.brushEnabled?"Brush ON":"Brush OFF"),this.elRefs.btnBrush.toggleClass("on",this.brushEnabled),new f.Notice(`Brush ${this.brushEnabled?"enabled":"disabled"}`,800)}async setYear(e){this.year=e,this.elRefs.yearEl.setText(String(this.year)),this.data=await this.loadData(this.year),this.firstDayMonday=(this.data.settings?.firstDayOfWeek??"mon")==="mon",this.renderPalette(),this.render(),this.renderAllRunPills()}promptGotoYear(){let e=window.prompt("Go to year:",String(this.year));if(!e)return;let t=Number(e);Number.isFinite(t)&&t>=1&&t<=9999?this.setYear(t):new f.Notice("Bad year")}jumpToMonthOf(e,t){e!==this.year?(this.pendingScrollToMonth=t,this.setYear(e)):this.scrollToMonth(t)}scrollToMonth(e){this.containerEl.querySelector(`.yp-month[data-month="${e}"]`)?.scrollIntoView({behavior:"smooth",block:"start"})}render(){let e=this.elRefs.grid;e.empty();let t=this.firstDayMonday?$:W;for(let n=0;n<12;n++){let a=e.createDiv({cls:"yp-month"});a.dataset.month=String(n),a.createEl("h3",{text:`${R[n]} ${this.year}`});let r=a.createDiv({cls:"yp-cal"}),d=r.createDiv({cls:"yp-weekdays"});t.forEach(u=>d.createDiv({text:u}));let i=r.createDiv({cls:"yp-weeks"}),s=V(this.year,n,this.firstDayMonday);for(let u=0;u<6;u++){let m=i.createDiv({cls:"yp-week"}),g=[];for(let c=0;c<7;c++){let p=u*7+c,l=s[p],y=m.createDiv({cls:"yp-day"});l.inMonth||y.addClass("is-outside"),G(l.y,l.m,l.d)&&y.addClass("is-today"),y.setText(String(l.d));let b=q(l.y,l.m,l.d);y.dataset.iso=b,this.paintCellFromData(y,b,l.inMonth),l.inMonth?(y.addEventListener("mousedown",x=>{x.button===0&&this.brushEnabled&&(this.isDragging=!0,this.pickAndPaint(b))}),y.addEventListener("mouseenter",()=>{this.isDragging&&this.brushEnabled&&this.pickAndPaint(b)}),y.addEventListener("mouseup",x=>{x.button===0&&(this.isDragging=!1,this.lastPickedISO=b)}),y.addEventListener("mouseover",()=>{this.lastPickedISO=b}),y.addEventListener("click",x=>{if(x.button===0){if(this.lastPickedISO=b,x.altKey){delete this.data.days[b],this.clearHoverTips(),this.updateDayCell(b),this.saveDebounced();return}this.brushEnabled||this.openEditNoteModal(b)}}),y.addEventListener("contextmenu",x=>{x.preventDefault(),this.openEditNoteModal(b)})):y.addEventListener("click",()=>this.jumpToMonthOf(l.y,l.m));let w=this.data?.days?.[b];g.push({iso:b,inMonth:l.inMonth,color:w?.color,note:w?.note,el:y})}this.renderRunPills(m,g),m.addEventListener("click",c=>{if(!c.altKey)return;let p=c.clientX,l=Array.from(m.querySelectorAll(".yp-day")),y=null;for(let w of l){let x=w.getBoundingClientRect();if(p>=x.left&&p<=x.right){y=w;break}}if(!y)return;let b=y.dataset.iso;if(this.lastPickedISO=b,y.classList.contains("is-outside")){let w=b.split("-").map(Number);this.jumpToMonthOf(w[0],w[1]-1)}else delete this.data.days[b],this.clearHoverTips(),this.updateDayCell(b),this.saveDebounced();c.stopPropagation()})}}this.pendingScrollToMonth!=null&&(this.scrollToMonth(this.pendingScrollToMonth),this.pendingScrollToMonth=null)}renderRunPills(e,t){e.querySelectorAll(".run-pill").forEach(a=>a.remove()),t.forEach(({el:a})=>a.classList.remove("hide-number"));let n=0;for(;n<t.length;){let a=n,r=t[n];if(!r.inMonth||!r.color){n++;continue}let d=n+1;for(;d<t.length&&t[d].inMonth&&t[d].color===r.color;)d++;let i="";for(let p=a;p<d;p++){let l=t[p].note?.trim();if(l){i=l;break}}let s=t[a].el,u=t[d-1].el,m=s.offsetLeft,g=u.offsetLeft+u.offsetWidth-s.offsetLeft,c=document.createElement("div");c.className="run-pill",c.style.left=`${m}px`,c.style.width=`${g}px`,c.style.background=t[a].color,c.style.color=C(t[a].color),c.textContent=i||"";for(let p=a;p<d;p++)t[p].el.classList.add("hide-number");e.appendChild(c),n=d}}renderAllRunPills(){let e=Array.from(this.containerEl.querySelectorAll(".yp-week"));for(let t of e){let a=Array.from(t.querySelectorAll(".yp-day")).map(r=>{let d=r.dataset.iso,i=!r.classList.contains("is-outside"),s=this.data?.days?.[d];return{iso:d,inMonth:i,color:s?.color,note:s?.note,el:r}});this.renderRunPills(t,a)}}openGroupSettingsModal(){let e=this,t=(this.data?.palettes?.items??[]).map(a=>({...a}));class n extends f.Modal{onOpen(){let{contentEl:r}=this;r.empty(),r.createEl("h3",{text:"Group Settings"}),this.table=r.createDiv(),this.renderTable();let d=r.createDiv({cls:"yp-row"}),i=d.createEl("button",{text:"Add group"}),s=d.createEl("button",{text:"Save"}),u=d.createEl("button",{text:"Cancel"});i.onclick=()=>{t.push({color:"#999999",label:"New group"}),this.renderTable()},s.onclick=async()=>{let g=e.data.palettes.items,c={};for(let p=0;p<Math.min(g.length,t.length);p++)g[p].color!==t[p].color&&(c[g[p].color]=t[p].color);if(e.data.palettes.items=t,Object.keys(c).length){let p=e.data.days;for(let l of Object.keys(p)){let y=p[l].color;y&&c[y]&&(p[l].color=c[y])}}await e.saveData(),e.renderPalette(),e.renderAllRunPills(),this.close()},u.onclick=()=>this.close();let m=document.createElement("style");m.textContent=`
          .gs-row { display:grid; grid-template-columns: 90px 1fr auto; gap:8px; align-items:center; margin:6px 0; }
          .gs-color { width:90px; }
          .gs-delete { margin-left:8px; }
          .gs-hint { font-size:12px; opacity:.7; margin-top:6px; }
        `,r.appendChild(m),r.createDiv({cls:"gs-hint",text:"Changing a group color recolors all its days"})}renderTable(){this.table.empty(),t.forEach((r,d)=>{let i=this.table.createDiv({cls:"gs-row"}),s=i.createEl("input",{attr:{type:"color"}});s.addClass("gs-color"),s.value=j(r.color||"")&&r.color.length===7?r.color:"#999999",s.oninput=()=>{r.color=s.value};let u=i.createEl("input",{attr:{type:"text",placeholder:"Label"}});u.value=r.label??"",u.oninput=()=>{r.label=u.value};let m=i.createEl("button",{text:"Delete",cls:"gs-delete"});m.onclick=()=>{t.splice(d,1),this.renderTable()}})}}new n(this.app).open()}openEditNoteModal(e){let t=this.year,n=e??this.lastPickedISO??(()=>{let m=new Date;return`${t}-${String(m.getMonth()+1).padStart(2,"0")}-${String(m.getDate()).padStart(2,"0")}`})();n.startsWith(String(t))||(n=`${t}-${n.slice(5)}`);let a=this.data?.days?.[n]??{},r=a.note??"",d=a.color??"",i=this.data.palettes.items,s=this;class u extends f.Modal{constructor(){super(...arguments);this.selectedColor=d}onOpen(){let{contentEl:c}=this;c.empty(),c.createEl("h3",{text:"Edit day"});let p=c.createDiv();p.createEl("label",{text:"Date (YYYY-MM-DD): "}),this.inputISO=p.createEl("input",{type:"date"}),this.inputISO.value=n,c.createEl("h4",{text:"Group color"}),this.colorWrap=c.createDiv({cls:"modal-color-chips"}),this.renderChips();let l=c.createDiv({cls:"mt-2"});l.createEl("label",{text:"Note:"}),this.textarea=l.createEl("textarea"),this.textarea.style.width="100%",this.textarea.style.height="96px",this.textarea.value=r;let y=c.createDiv({cls:"modal-button-container"}),b=y.createEl("button",{text:"Save"}),w=y.createEl("button",{text:"Clear note"}),x=y.createEl("button",{text:"Clear color"}),O=y.createEl("button",{text:"Cancel"});b.onclick=()=>{let v=this.inputISO.value.trim(),E=this.textarea.value.trim();if(!/^\d{4}-\d{2}-\d{2}$/.test(v)){new f.Notice("Bad date format");return}let k=s.data.days[v]??{};E?k.note=E:delete k.note,this.selectedColor?k.color=this.selectedColor:delete k.color,!k.note&&!k.color?delete s.data.days[v]:s.data.days[v]=k,s.lastPickedISO=v,s.updateDayCell(v),s.saveDebounced(),s.renderAllRunPills(),this.close()},w.onclick=()=>{let v=this.inputISO.value.trim(),E=s.data.days[v]??{};delete E.note,E.color?s.data.days[v]=E:delete s.data.days[v],s.lastPickedISO=v,s.updateDayCell(v),s.saveDebounced(),s.renderAllRunPills(),this.close()},x.onclick=()=>{let v=this.inputISO.value.trim(),E=s.data.days[v]??{};delete E.color,E.note?s.data.days[v]=E:delete s.data.days[v],s.lastPickedISO=v,s.updateDayCell(v),s.saveDebounced(),s.renderAllRunPills(),this.close()},O.onclick=()=>this.close();let P=document.createElement("style");P.textContent=`
          .modal-color-chips { display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 8px; }
          .chip { width:22px; height:22px; border-radius:6px; border:1px solid var(--background-modifier-border); cursor:pointer; display:inline-block; }
          .chip.active { outline:2px solid var(--interactive-accent); }
          .chip-label { font-size:12px; margin-left:4px; opacity:.8; }
          .chip-wrap { display:flex; align-items:center; gap:6px; }
        `,c.appendChild(P)}renderChips(){this.colorWrap.empty(),i.forEach(c=>{let p=this.colorWrap.createDiv({cls:"chip-wrap"}),l=p.createDiv({cls:"chip"});l.style.background=c.color,this.selectedColor===c.color&&l.addClass("active"),l.onclick=()=>{this.selectedColor=c.color,this.renderChips()},p.createSpan({cls:"chip-label",text:c.label??""})})}}new u(this.app).open()}pickAndPaint(e){if(this.lastPickedISO=e,!this.brushEnabled||!this.data)return;let t=this.brushColor,n=this.data.days[e]??{};n.color!==t&&(n.color=t,this.data.days[e]=n,this.updateDayCell(e),this.saveDebounced(),this.renderAllRunPills())}paintCellFromData(e,t,n){if(!n){e.classList.remove("has-color"),e.style.color="",e.querySelector(".note-dot")?.remove(),e.querySelector(".note-inline")?.remove();return}let a=this.data?.days?.[t],r=a?.color,d=a?.note;if(r?(e.style.background=r,e.style.borderColor="transparent",e.classList.add("has-color"),e.style.color=C(r)):(e.style.background="var(--background-primary)",e.style.borderColor="var(--background-modifier-border)",e.classList.remove("has-color"),e.style.color=""),d&&d.trim()!==""){if(!e.querySelector(".note-dot")){let i=document.createElement("div");i.className="note-dot",e.appendChild(i)}e.onmouseenter=()=>{let i=document.createElement("div");i.className="yp-tooltip",i.innerText=d.trim(),document.body.appendChild(i);let s=e.getBoundingClientRect();i.style.position="fixed",i.style.left=s.left+"px",i.style.top=s.bottom+4+"px",i.style.zIndex="9999",e.onmouseleave=()=>i.remove()}}else e.querySelector(".note-dot")?.remove(),e.onmouseenter=null,e.onmouseleave=null;e.querySelector(".note-inline")?.remove(),e.classList.remove("hide-number")}updateDayCell(e){this.clearHoverTips();let t=this.containerEl.querySelectorAll(`.yp-day[data-iso="${e}"]`);t.forEach(a=>{let r=!a.classList.contains("is-outside");this.paintCellFromData(a,e,r)}),this.containerEl.querySelectorAll(".yp-day.is-selected").forEach(a=>a.classList.remove("is-selected")),this.containerEl.querySelector(`.yp-day[data-iso="${this.lastPickedISO??""}"]`)?.classList.add("is-selected"),t.forEach(a=>{let r=a.closest(".yp-week");if(!r)return;let i=Array.from(r.querySelectorAll(".yp-day")).map(s=>{let u=s.dataset.iso,m=!s.classList.contains("is-outside"),g=this.data?.days?.[u];return{iso:u,inMonth:m,color:g?.color,note:g?.note,el:s}});this.renderRunPills(r,i)})}recomputeCellHeight(){let e=this.elGlobal.getBoundingClientRect().height+this.elLocal.getBoundingClientRect().height+this.elHint.getBoundingClientRect().height,a=Math.max(320,window.innerHeight-e-90)/4,r=Math.max(20,Math.min(42,Math.floor((a-34)/7)));this.elRefs.grid.style.setProperty("--yp-day-h",`${r}px`)}};
